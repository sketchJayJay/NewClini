<div id="odontograma-wrap"
     data-pid="{{ patient.id }}"
     data-save-url="{{ url_for('patients.odontograma_save_json', pid=patient.id) }}"
     style="position:relative">

  <style>
    :root{ --border:#374151; }
    .field{
      background:#fff; color:#111; border:1px solid #e5e7eb;
      border-radius:8px; padding:8px 10px; min-height:36px;
    }
    .tooth{ cursor:pointer; }
    .tooth:hover rect{ stroke:#7ea6ff }
    .tooth.selected rect{ stroke:#60a5fa; stroke-width:2 }
    .odonto-menu{
      position:absolute; z-index:20; background:#0f1115; border:1px solid #1f2937;
      border-radius:12px; padding:10px; width:260px; box-shadow:0 10px 30px rgba(0,0,0,.35);
      display:none
    }
    .odonto-menu .row{ display:flex; gap:6px; margin-top:8px }
    .odonto-tip{
      position:absolute; pointer-events:none; background:#0f1115; border:1px solid #1f2937;
      border-radius:8px; padding:6px 8px; font-size:12px; color:#cbd5e1; display:none; z-index:15
    }
  </style>

  <svg id="odontograma-svg" viewBox="0 0 1000 420"
       style="width:100%;max-width:950px;background:#101114;border:1px solid #1f2937;border-radius:12px">
    {% macro tooth(x,y,w,h,num) -%}
      <g class="tooth" data-tooth="{{ num }}">
        <rect x="{{ x }}" y="{{ y }}" width="{{ w }}" height="{{ h }}" rx="10" ry="10"
              fill="#111827" stroke="#374151"></rect>
        <text x="{{ x + w/2 }}" y="{{ y + h*0.55 }}" text-anchor="middle"
              font-size="20" fill="#e5e7eb">ü¶∑</text>
        <text x="{{ x + w/2 }}" y="{{ y + h - 6 }}" text-anchor="middle"
              font-size="11" fill="#9ca3af">{{ num }}</text>
      </g>
    {%- endmacro %}

    {% set top_left    = [18,17,16,15,14,13,12,11] %}
    {% set top_right   = [21,22,23,24,25,26,27,28] %}
    {% set bottom_right= [31,32,33,34,35,36,37,38] %}
    {% set bottom_left = [48,47,46,45,44,43,42,41] %}

    {% for i in range(top_left|length) %}
      {{ tooth(40 + i*60, 40, 50, 60, top_left[i]) }}
    {% endfor %}
    {% for i in range(top_right|length) %}
      {{ tooth(40 + i*60, 140, 50, 60, top_right[i]) }}
    {% endfor %}
    {% for i in range(bottom_right|length) %}
      {{ tooth(40 + i*60, 240, 50, 60, bottom_right[i]) }}
    {% endfor %}
    {% for i in range(bottom_left|length) %}
      {{ tooth(40 + i*60, 340, 50, 60, bottom_left[i]) }}
    {% endfor %}
  </svg>

  <div id="odonto-menu" class="odonto-menu">
    <div style="font-weight:600;margin-bottom:6px;color:#e5e7eb">Definir status</div>
    <select id="odonto-status" class="field" style="width:100%">
      <option value="saudavel">Saud√°vel</option>
      <option value="carie">C√°rie</option>
      <option value="restauracao">Restaura√ß√£o</option>
      <option value="canal">Trat. de canal</option>
      <option value="fratura">Fratura</option>
      <option value="ausente">Ausente/Extra√≠do</option>
      <option value="implante">Implante</option>
      <option value="protese">Pr√≥tese</option>
      <option value="mobilidade">Mobilidade</option>
      <option value="placa">Placa</option>
    </select>
    <div class="row">
      <input id="odonto-note" class="field" placeholder="Observa√ß√£o (opcional)" style="flex:1">
    </div>
    <div class="row" style="justify-content:flex-end">
      <button id="odonto-cancel" class="btn btn-sm btn-outline-light">Cancelar</button>
      <button id="odonto-save" class="btn btn-sm btn-primary">Salvar</button>
    </div>
  </div>

  <div id="odonto-tip" class="odonto-tip"></div>
</div>

<script src="{{ url_for('static', filename='odontograma_inline.js') }}"></script>
<script>
  window.ODONTO_STATE = {{ mapa|tojson }};
</script>
